---
title: "Proyecto de Análisis Exploratorio de Datos"
authors: Eric Villaescusa, Isaac Pazmiño, Alexandra Estela, Óscar Ibáñez, Adrià Reyes,
  Hubert Stolarz
output:
  pdf_document: default
  html_document: default
---
```{r setup, include=FALSE, echo=FALSE, warning=FALSE}
#Cargamos las librerias necesarias
knitr::opts_chunk$set(echo = TRUE)

# Especificamos las librerías necesarias en esta lista

packages = c("lubridate","readr","dplyr","rlist", "stringr")

#Esta función sirve para comprobar que los paquetes estan instalados en la máquina local
#Si un paquete ya esta instalado lo cargará
#Si no hay paquetes, instalará y cargará los faltantes.
package.check <- lapply(packages, FUN = function(x) {
  if (!require(x, character.only = TRUE)) {
    install.packages(x, dependencies = TRUE,repos='http://cran.rediris.es')
  }
  library(x, character.only = TRUE)
})

#Verifica que estan cargados.
search()

```

```{r, echo=FALSE, warning=FALSE}
#Cargamos los nombres de cada tiket (guardados en la carpeta data)
files <- list.files(path = "./data", pattern = ".txt", full.names = TRUE)

#Creamos una lista que contendrá cada ticket.
tickets <- list()

# Crear una lista vacía para almacenar las fechas
fechas <- vector("list", length = length(files))

# Ajustamos la lectura y transformación de productos
for (file in files) {
  lineas <- read_lines(file, locale = locale(encoding = 'latin1'))
  supermercado <- lineas[1]
  direccion <- lineas[2]
  ciudad <- lineas[3]
  telefono <- lineas[4]
  fecha <- lineas[5]
  factura <- lineas[6]
  indiceinicio <- grep("Descripción P. Unit Importe", lineas) 
  indicefinal <- grep("TOTAL", lineas)
  productos_brutos <- lineas[(indiceinicio + 2):(indicefinal - 1)]
  
# Guardar la fecha en la lista de fechas
fechas[[file]] <- fecha
  
  # Nuevo vector para productos procesados
  productos <- vector("list", length = length(productos_brutos))
  i <- 1
  while (i <= length(productos_brutos)) {
    linea_actual = productos_brutos[i]
    if (grepl('/kg', linea_actual)) {
      # Producto fresco: incluir la siguiente línea para el precio
      productos[[i]] <- paste(linea_actual, productos_brutos[i + 1], sep = " ")
      i <- i + 1  # Saltar la siguiente línea ya que se incluyó con el producto fresco
    } else {
      # Producto normal
      productos[[i]] <- linea_actual
    }
    i <- i + 1
  }

  # Convertir la lista de productos a un vector para su procesamiento posterior
  productos <- unlist(productos)

  # Creación del dataframe como anteriormente
  datos <- data.frame(
    Supermercado = supermercado,
    Dirección = direccion,
    Ciudad = ciudad,
    Telefono = telefono,
    Fecha = fecha,
    Productos = productos,
    Factura = factura,
    stringsAsFactors = FALSE
  )

  # Agregar datos al listado de tickets
  tickets <- list.append(tickets, datos)
}

# Ahora productos es una lista de data frames, cada uno con información de un ticket
datoscompletos <- do.call(rbind, tickets)

# Procesar productos para extraer Cantidad, Producto y Precio
productos_procesados <- data.frame(
  Cantidad = as.numeric(sub("([0-9]+).*", "\\1", datoscompletos$Productos)),
  Producto = sub("^[0-9]+([^0-9.]+)[0-9,\\. ]+$", "\\1", datoscompletos$Productos),
  Precio = as.numeric(gsub(",", ".", gsub(".* ([0-9,]+)$", "\\1", datoscompletos$Productos))),
  stringsAsFactors = FALSE
)
productos_procesados$Producto <- trimws(productos_procesados$Producto)
Productos_procesados<-productos_procesados %>%
  select(-Cantidad)
productos_frescos <- productos_procesados %>%
  filter(grepl("/kg", Producto)) %>%
  mutate(
    Producto = gsub("^[0-9]+([^0-9.]+)[0-9,\\. ]+$", "\\1", Producto),
    Peso = gsub(".*?(\\d+,\\d+ kg).*", "\\1", Producto),
    PrecioPorKg = gsub(".*?(\\d+,\\d+/kg).*", "\\1", Producto),
    PrecioTotal = as.numeric(gsub(",", ".", gsub(".* ([0-9,]+)", "\\1", Producto))),
    Producto = trimws(Producto)
  )

# Data frame de fechas
Data_Fecha <- data.frame(Fecha = unlist(fechas), row.names = NULL)

```

##INTRODUCCIÓN

Este proyecto aspira a realizar un análisis exhaustivo de los patrones de compra de los clientes de Mercadona, una destacada cadena de supermercados en España, basándose en los tickets de compra recogidos durante el período 2023-2024. Con el objetivo de identificar tendencias de consumo, determinar los productos más y menos comprados, examinar las preferencias horarias de compra, y evaluar los métodos de pago preferidos por los consumidores, este estudio profundo busca no solo comprender los hábitos de compra en Mercadona, sino también ofrecer recomendaciones estratégicas para optimizar tanto las estrategias de marketing como la gestión de inventario de la cadena. Este enfoque analítico promete revelar insights valiosos para mejorar la experiencia de compra de los clientes y fortalecer la posición de Mercadona en el mercado.

#1.1 Material y Métodos

Detallaremos los materiales y métodos empleados en el análisis, abordando los desafíos encontrados, como la necesidad de convertir los datos de su forma original ("Raw data") a un formato técnicamente adecuado que permita un análisis eficiente. Este proceso incluirá la codificación manual de ciertas variables y la normalización de formatos, especialmente en lo que respecta a las fechas y métodos de pago, así como el desglose de los porcentajes de IVA para asegurar coherencia a lo largo de todo el análisis.

#1.1.1 Carga de librerías y datos: 
Primero hemos de descargar las librerías que sean necesarias para la carga y análisis de los datos. En este caso hemos instalado tres: ‘readr’, ‘dplyr’ y ‘rlist’. 
La librería readr sirve para leer datos de archivos de manera eficiente. La librería dplyr nos servirá para el procesamiento y manipulación de los datos cargados. Y por último, rlist manipula las listas en R. 
Los datos utilizados en este análisis provienen exclusivamente de los archivos de texto que contienen los registros detallados de cada compra (tickets), almacenados en la carpeta data de nuestro proyecto. Este conjunto de datos incluye una amplia gama de información, como el detalle de los productos comprados, la fecha y hora de la compra, el método de pago, datos de la sucursal donde se está efectuando la compra, desglose del 'IVA'. A través de la exploración de 12 tickets, se ha conformado un dataframe que nos permite realizar un análisis significativo sobre las tendencias de consumo.
Para la lectura de datos hemos hecho uso de la primera librería mencionada (readr), iterando con un bucle sobre files (que son los archivos de texto) y creando un dataframe por cada ticket. 

#1.2. Características generales de los datos
Variables: 
En nuestro dataframe creado, llamado datos, se le asigna un total de 9 variables: supermercado, direccion, ciudad, teléfono, fecha, factura, IVA 10%, IVA 21% e IVA 5%, Sin IVA e IVA. 
Descripción detallada de las Variables:
Supermercado: Nombre del supermercado donde se realizó la compra. Este dato es importante para identificar el punto de venta específico dentro de la cadena de supermercados.
Dirección: Dirección física del supermercado. Proporciona un nivel adicional de detalle geográfico que podría ser útil para análisis relacionados con la ubicación  y asi saber que afluencia de personas tiene cada supermercado y de esta manera considerar el incremento de infraestructura en esa zona, mayor manejo de productos, entre otros.
Ciudad: La ciudad en la que se encuentra el supermercado. Esta variable permite realizar análisis por ciudad, identificando patrones de consumo provincial y regional.
Teléfono: Número de teléfono del supermercado. Aunque esta información puede no ser directamente relevante para el análisis de patrones de compra, sirve como dato de contacto.
Fecha: Fecha y hora en que se realizó la compra. Es fundamental para análisis temporales, como identificar picos de compra durante el día, la semana o tendencias dependiendo de la temporada del año/mes.
Factura: Número o código de la factura asociada a cada compra. Un identificador único para cada transacción que permite el seguimiento de las compras individuales.
IVA (10%, 21%, 5%): Porcentajes de IVA aplicados a los productos adquiridos. Estos datos son cruciales para análisis financieros y para entender cómo los diferentes tipos de productos contribuyen a las ventas totales.
Sin IVA: Monto total de los productos exentos de IVA. Ofrece una visión de la proporción de productos no gravados en las compras.
IVA: Monto total del IVA cobrado en la compra. Un indicador importante de la carga fiscal de las transacciones.
Para finalizar, se crea un dataframe vacío para almacenar la información de todos los tickets, es decir, un dataframe que almacene todos los anteriores dataframes, llamado datoscompletos. 

#1.3 Resultados
Presentaremos los hallazgos y logros clave derivados del análisis, proporcionando una base sólida para decisiones estratégicas informadas y mejoras operativas.

# Preguntas

Ahora que tenemos los tickets cargados correctamente en un data frame, nos planteamos las preguntas que queremos rresponder mediante el análisis exploratorio.

1.  ¿cuáles son los productos más comprados?

2.  ¿A qué hora se realizan más compras?

3.  ¿Qué método de pago es el más popular?

4.  ¿Cuáles son los productos menos comprados?