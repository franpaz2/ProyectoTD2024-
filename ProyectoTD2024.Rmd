---
title: "ProyectoTD2024"
author: Eric Villaescusa, Isaac Pazmiño, Alexandra Estela, Oscar Ibañez, Adrià Reyes,
  Hubert Stolarz,Joyce Kemeni
date: "2024-03-30"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE, echo=FALSE, warning=TRUE}
#Cargamos las librerias necesarias
library(knitr)
library(pacman)
p_load(dplyr,lubridate,tidyverse,wordcloud,quanteda, tm,tidytext, ggwordcloud, wordcloud2,ggplot2)

options(width = 100)
# Opciones generales chunks
opts_chunk$set(echo=T,message = F, error = F, warning = T, comment = NA, fig.align = 'center', dpi = 100, tidy = F, cache.path = '.cache/', fig.path = './figure/')

# Especificamos las librerías necesarias en esta lista

packages = c("lubridate","readr","dplyr","rlist")

#Esta función sirve para comprobar que los paquetes estan instalados en la máquina local
#Si un paquete ya esta instalado lo cargará
#Si no hay paquetes, instalará y cargará los faltantes.
package.check <- lapply(packages, FUN = function(x) {
  if (!require(x, character.only = TRUE)) {
    install.packages(x, dependencies = TRUE,repos='http://cran.rediris.es')
  }
  library(x, character.only = TRUE)
})

#Verifica que estan cargados.
search()

```



```{r, echo=FALSE, warning=FALSE}
#Cargamos los nombres de cada tiket (guardados en la carpeta data)
files <- list.files(path = "./data", pattern = ".txt", full.names = TRUE)

#Creamos una lista que contendrá cada ticket.
tickets <- list()

#Asignamos las líneas de los archivos .txt
for (file in files) {
  linea <- read_lines(file, locale = locale(encoding = 'latin1'))
  supermercado <- linea[1]
  direccion <- linea[2]
  ciudad <- linea[3]
  telefono <- linea[4]
  fecha <- linea[5]
  
  factura <- linea[6]
  indiceinicio <- grep("Descripción P. Unit Importe", linea) 
  indicefinal <- grep("TOTAL", linea)
  productos <- linea[(indiceinicio + 2):(indicefinal - 1)]
  #productos_fresco <- linea[grep('/kg', linea)]
  iVA_10_idx <- grep("10%", linea)
  iVA_21_idx <- grep("21%", linea)
  iVA_5_idx <- grep("\\b5%", linea) 
  candidatos_sinIVA_idx <- grep("\\b0,00\\b", linea)
  sinIVA_idx <- candidatos_sinIVA_idx[!grepl("PARKING", linea[candidatos_sinIVA_idx])]
  iVA_10_value <- ifelse(length(iVA_10_idx) > 0, linea[iVA_10_idx[1]], NA)
  iVA_21_value <- ifelse(length(iVA_21_idx) > 0, linea[iVA_21_idx[1]], NA)
  iVA_5_value <- ifelse(length(iVA_5_idx) > 0, linea[iVA_5_idx[1]], NA)
  sinIVA_value <- ifelse(length(sinIVA_idx) > 0, linea[sinIVA_idx[1]], NA)
#Creamos un data frame con los datos asignados
  datos <- list(
    Supermercado = supermercado,
    Dirección = direccion,
    Ciudad = ciudad,
    Telefono = telefono,
    Fecha = fecha,
    Productos = productos[-grep('/kg', productos)],
    Factura = factura,
    Iva_10 = iVA_10_value,
    Iva_21 = iVA_21_value,
    Iva_5 = iVA_5_value,
    SinIVA = sinIVA_value,
    stringsAsFactors = FALSE
  
  )
  #Le asigno cada ticket a cada elemento de la lista
  tickets <- list.append(tickets, datos)
}

#Creamos un dataframe vacio donde añadiremos la información contenida en cada ticket.
# Combinez les éléments de la liste en un seul dataframe
datoscompletos <- do.call(rbind, tickets)
datos_completos<-as.data.frame(datoscompletos)

# Pongo los valores de las horas donde se encuentran los puntos y roto las etiquetas del eje x para que sean legibles
axis(1, at = horas_posix, labels = format(horas_posix, "%H:%M"), las = 2)

```











##INTRODUCCIÓN

Este proyecto aspira a realizar un análisis exhaustivo de los patrones de compra de los clientes de Mercadona, una destacada cadena de supermercados en España, basándose en los tickets de compra recogidos durante el período 2023-2024. Con el objetivo de identificar tendencias de consumo, determinar los productos más y menos comprados, examinar las preferencias horarias de compra, y evaluar los métodos de pago preferidos por los consumidores, este estudio profundo busca no solo comprender los hábitos de compra en Mercadona, sino también ofrecer recomendaciones estratégicas para optimizar tanto las estrategias de marketing como la gestión de inventario de la cadena. Este enfoque analítico promete revelar insights valiosos para mejorar la experiencia de compra de los clientes y fortalecer la posición de Mercadona en el mercado.

#1.1 Material y Métodos

Detallaremos los materiales y métodos empleados en el análisis, abordando los desafíos encontrados, como la necesidad de convertir los datos de su forma original ("Raw data") a un formato técnicamente adecuado que permita un análisis eficiente. Este proceso incluirá la codificación manual de ciertas variables y la normalización de formatos, especialmente en lo que respecta a las fechas y métodos de pago, así como el desglose de los porcentajes de IVA para asegurar coherencia a lo largo de todo el análisis.

#1.1.1 Carga de librerías y datos: 
Primero hemos de descargar las librerías que sean necesarias para la carga y análisis de los datos. En este caso hemos instalado tres: ‘readr’, ‘dplyr’ y ‘rlist’. 
La librería readr sirve para leer datos de archivos de manera eficiente. La librería dplyr nos servirá para el procesamiento y manipulación de los datos cargados. Y por último, rlist manipula las listas en R. 
Los datos utilizados en este análisis provienen exclusivamente de los archivos de texto que contienen los registros detallados de cada compra (tickets), almacenados en la carpeta data de nuestro proyecto. Este conjunto de datos incluye una amplia gama de información, como el detalle de los productos comprados, la fecha y hora de la compra, el método de pago, datos de la sucursal donde se está efectuando la compra, desglose del 'IVA'. A través de la exploración de 12 tickets, se ha conformado un dataframe que nos permite realizar un análisis significativo sobre las tendencias de consumo.
Para la lectura de datos hemos hecho uso de la primera librería mencionada (readr), iterando con un bucle sobre files (que son los archivos de texto) y creando un dataframe por cada ticket. 

#1.2. Características generales de los datos
Variables: 
En nuestro dataframe creado, llamado datos, se le asigna un total de 9 variables: supermercado, direccion, ciudad, teléfono, fecha, factura, IVA 10%, IVA 21% e IVA 5%, Sin IVA e IVA. 
Descripción detallada de las Variables:
Supermercado: Nombre del supermercado donde se realizó la compra. Este dato es importante para identificar el punto de venta específico dentro de la cadena de supermercados.
Dirección: Dirección física del supermercado. Proporciona un nivel adicional de detalle geográfico que podría ser útil para análisis relacionados con la ubicación  y asi saber que afluencia de personas tiene cada supermercado y de esta manera considerar el incremento de infraestructura en esa zona, mayor manejo de productos, entre otros.
Ciudad: La ciudad en la que se encuentra el supermercado. Esta variable permite realizar análisis por ciudad, identificando patrones de consumo provincial y regional.
Teléfono: Número de teléfono del supermercado. Aunque esta información puede no ser directamente relevante para el análisis de patrones de compra, sirve como dato de contacto.
Fecha: Fecha y hora en que se realizó la compra. Es fundamental para análisis temporales, como identificar picos de compra durante el día, la semana o tendencias dependiendo de la temporada del año/mes.
Factura: Número o código de la factura asociada a cada compra. Un identificador único para cada transacción que permite el seguimiento de las compras individuales.
IVA (10%, 21%, 5%): Porcentajes de IVA aplicados a los productos adquiridos. Estos datos son cruciales para análisis financieros y para entender cómo los diferentes tipos de productos contribuyen a las ventas totales.
Sin IVA: Monto total de los productos exentos de IVA. Ofrece una visión de la proporción de productos no gravados en las compras.
IVA: Monto total del IVA cobrado en la compra. Un indicador importante de la carga fiscal de las transacciones.
Para finalizar, se crea un dataframe vacío para almacenar la información de todos los tickets, es decir, un dataframe que almacene todos los anteriores dataframes, llamado datoscompletos. 

#1.3 Resultados
Presentaremos los hallazgos y logros clave derivados del análisis, proporcionando una base sólida para decisiones estratégicas informadas y mejoras operativas.

# Preguntas

Ahora que tenemos los tickets cargados correctamente en un data frame, nos planteamos las preguntas que queremos rresponder mediante el análisis exploratorio.
```{r}
library(ggplot2)
```

1.  ¿cuáles son los productos más comprados?
```{r}
productos = list()
    for (ticket in tickets) {
      productos <- list.append(productos, ticket$Productos)
    }
    library(stringr)

    eliminar_numeros <- function(productos) {
      # Aplicar la función a cada elemento de la lista
      eliminar_numeros <- lapply(productos, function(x) {
        # Eliminar el primer número delante de la información
        x <- str_replace(x, "^[0-9]+", "")
        # Eliminar el float del final si hay
        x <- str_replace(x, "[0-9],[0-9]+$", "")
        return(x)
      })
      # Convertir la lista a un vector de caracteres
      eliminar_numeros <- unlist(eliminar_numeros)
      return(eliminar_numeros)
    }
    productos_filtrado <- eliminar_numeros(productos)
    
  

    # Contar la frecuencia de cada producto en la lista
    frecuencia_productos <- table(productos_filtrado)

    # Convertir la tabla de frecuencias en un data frame
    df_frecuencias <- as.data.frame(frecuencia_productos)
    colnames(df_frecuencias) <- c("Producto", "Frecuencia")

    # Ordenar el data frame por frecuencia de mayor a menor
    df_frecuencias <- df_frecuencias[order(-df_frecuencias$Frecuencia),]

    # Obtener los 20 productos más repetidos
    top_10_productos <- head(df_frecuencias, 10)

    # Crear el gráfico circular con los 10 productos más vendidos
    ggplot(top_10_productos, aes(x = "", y = Frecuencia, fill = Producto)) +
      geom_bar(stat = "identity") +
      coord_polar("y", start = 0) +
      theme_void() +
      labs(title = "Frecuencia de los 10 productos más vendidos") +
      scale_fill_manual(values = rainbow(length(top_10_productos$Producto))) + # Colores
      theme(legend.position = "right") # Posición de la leyenda
```

2.  ¿A qué hora se realizan más compras?

```{r}
# Supprimons la partie " OP: " de la variable Fecha
datos_completos$Fecha <- sub(" OP:.*", "", datos_completos$Fecha)

datos_completos <- datos_completos[!is.na(datos_completos$Hora), ]

# Extraemos la hora en la variable Fecha
datos_completos$Hora <- format(as.POSIXct(strptime(datos_completos$Fecha, "%d/%m/%Y %H:%M")), format = "%H:%M")

# Miramos las primeras líneas para confirmar que está correctamente estructurado
head(datos_completos$Hora)

# Escojemos solo la hora del formato de hora y minutos "%H:%M"
datos_completos$Hora_solo <- substr(datos_completos$Hora, 1, 2)
# Contar la frecuencia de cada producto en la lista
    frecuencia_compras <- table(datos_completos$Hora_solo)

# Convertir la tabla de frecuencias en un data frame
df_fre_compras <- as.data.frame(frecuencia_compras)
colnames(df_fre_compras) <- c("Hora", "Frequencia")

# Crear un histograma de compras por hora
ggplot(df_fre_compras, aes(x = Hora, y = Frequencia)) +
  geom_bar(stat = "identity", fill = "skyblue", color = "black") +
  labs(title = "Distribución de número de compras por hora",
       x = "Hora",
       y = "Número de compras")

# Gráfico de dispersión de compras por hora

# Crear un vector de horas con los valores de la columna Hora
horas <- c("18:56", "13:41", "19:20", "11:19", "12:47", "17:13", "19:30", "19:56", "17:15", "20:27", "14:57", "20:12")
# Convertir las horas a un formato adecuado con POSIXct
horas_posix <- as.POSIXct(horas, format = "%H:%M")
# Crear valores para el eje y 
valores <- 1:length(horas)

# Crear el gráfico de dispersión
plot(horas_posix, valores, 
     type = "n",  # Tipo de gráfico: "n" en blanco
     pch = 16,    # Tipo de marcador para los puntos
     col = "blue",   # Color de los puntos y líneas
     xlab = "Hora",  # Etiqueta del eje x
     ylab = "Valor",  # Etiqueta del eje y
     main = "Gráfico de Dispersión con Horas")

# Agregar los puntos sin líneas entre ellos
points(horas_posix, valores, pch = 16, col = "skyblue")

```



3.  ¿Qué método de pago es el más popular?
```{r}



```


4.  ¿Cuáles son los productos menos comprados?
```{r}
# Contar la frecuencia de cada producto en la lista
frecuencia_productos <- table(productos_filtrado)

# Convertir la tabla de frecuencias en un data frame
df_frecuencias <- as.data.frame(frecuencia_productos)
colnames(df_frecuencias) <- c("Producto", "Frecuencia")

# Ordenar el data frame por frecuencia de menor a mayor
df_frecuencias <- df_frecuencias[order(df_frecuencias$Frecuencia),]

# Obtener los 10 productos menos repetidos
top_10_productos <- head(df_frecuencias, 10)

# Crear el gráfico circular con los 10 productos menos vendidos
ggplot(top_10_productos, aes(x = "", y = Frecuencia, fill = Producto)) +
  geom_bar(stat = "identity") +
  coord_polar("y", start = 0) +
  theme_void() +
  labs(title = "Frecuencia de los 10 productos menos vendidos") +
  scale_fill_manual(values = rainbow(length(top_10_productos$Producto))) + # Colores
  theme(legend.position = "right") # Posición de la leyenda
```
