---
title: "ProyectoTD2024"
author: "Eric Villaescusa, Isaac Pazmiño, Alexandra Estela, Oscar Ibañez, Adrià Reyes,
  Hubert Stolarz,Joyce Kemeni"
date: "30/03/2024"
output:
  
  bookdown::html_document2:
    echo: true
    number_sections: true
    theme: spacelab
    toc: true
  html_document:
    echo: true
    number_sections: true
    theme: lumen
    toc: true
  html_notebook:
    echo: true
    number_sections: true
    toc: true
  pdf_document:
    toc: true
    toc_depth: 3
    number_sections: true
  bookdown::pdf_document2:
    toc: true
    toc_depth: 3
    number_sections: true
always_allow_html: true
params:
  lang: ES
lang: "`r switch(params$lang, ES = 'es-ES', EN = 'en-US')`"
subtitle: "Tratamiento de Datos. Grado en Ciencia de Datos- UV"
language:
  label:
    fig: 'Figura '
    tab: 'Tabla '
    eq: 'Ecuación '
    thm: 'Teorema '
    lem: 'Lema '
    def: 'Definición '
    cor: 'Corolario '
    prp: 'Proposición '
    exm: 'Ejemplo '
    exr: 'Ejercicio '
    proof: 'Demostración. '
    remark: 'Nota: '
    solution: 'Solución. '
---

```{r setup, cache = F, echo = F, message = F, warning = F, tidy = F}


# CONFIGURACIÓN GENERAL
library(knitr)
options(width = 100)

# Opciones generales de los chucks. Se utilizarán salvo cambios en el chunk
opts_chunk$set(echo=F, message = F, error = F, warning = F, comment = NA, fig.align = 'center', dpi = 200, tidy = F, cache.path = '.cache/', fig.path = './figura/')

# Opciones generales de dígitos cuando se incluyen tablas
#options(xtable.type = 'html')
knit_hooks$set(inline = function(x) {
  
  if(is.numeric(x)) {
    round(x, getOption('digits'))
  } else {
    paste(as.character(x), collapse = ', ')
  }
})
#knit_hooks$set(plot = knitr:::hook_plot_html)
```
# Introducción

Este proyecto aspira a realizar un análisis exhaustivo de los patrones de compra de los clientes de Mercadona, una destacada cadena de supermercados en España, basándose en los tickets de compra recogidos durante el período 2023-2024.

Con el objetivo de identificar tendencias de consumo, determinar los productos más y menos comprados, examinar las preferencias horarias de compra, y evaluar los métodos de pago preferidos por los consumidores, este estudio profundo busca no solo comprender los hábitos de compra en Mercadona, sino también ofrecer recomendaciones estratégicas para optimizar tanto las estrategias de marketing como la gestión de inventario de la cadena. Este enfoque analítico promete revelar insights valiosos para mejorar la experiencia de compra de los clientes y fortalecer la posición de Mercadona en el mercado.

## Instalación automática de paquetes

Para la preparación de nuestro entorno de trabajo y la manipulación de los datos, hemos instalado y cargado varias librerías relevantes.

dplyr: Esta librería es fundamental para el procesamiento y manipulación de datos. Nos proporciona una amplia gama de funciones para realizar operaciones de filtrado, selección, agrupación y resumen de datos de manera eficiente.

lubridate: Utilizamos esta librería para trabajar con fechas y horas de forma más sencilla. Nos permite realizar operaciones como extracción de partes de fecha, cálculos de diferencia entre fechas, etc.

tidyverse: Tidyverse es un conjunto de paquetes de R diseñados para la ciencia de datos. Incluye varias librerías útiles, como ggplot2 para visualización de datos, tidyr para manipulación de datos en formato "tidy" y purrr para programación funcional.

ggplot2: Es una librería ampliamente utilizada para la visualización de datos en R. Proporciona una sintaxis intuitiva y poderosa para crear una variedad de gráficos estadísticos.

Estas librerías nos brindan las herramientas necesarias para llevar a cabo el análisis exploratorio de los datos de los tickets de supermercado, desde la carga y limpieza de los datos hasta la visualización y extracción de patrones significativos.

```{r pac, message=FALSE}
# Asegúrate que el paquete "pacman" está instalado
if (!require("pacman")) install.packages("pacman")

# Paquetes disponibles desde CRAN
#################################
pacman::p_load(dplyr,lubridate,tidyverse,wordcloud,quanteda, tm,tidytext, ggwordcloud, wordcloud2,ggplot2)
```

## Importación Datos

Para este análisis hemos recibido los datos en forma de tickest con formato pdf que hemos tenido que pasar a txt.

Descripción detallada de las Variables:

Supermercado: Nombre del supermercado donde se realizó la compra. Este dato es importante para identificar el punto de venta específico dentro de la cadena de supermercados.

Dirección: Dirección física del supermercado. Proporciona un nivel adicional de detalle geográfico que podría ser útil para análisis relacionados con la ubicación y asi saber que afluencia de personas tiene cada supermercado y de esta manera considerar el incremento de infraestructura en esa zona, mayor manejo de productos, entre otros.

Ciudad: La ciudad en la que se encuentra el supermercado. Esta variable permite realizar análisis por ciudad, identificando patrones de consumo provincial y regional.

Teléfono: Número de teléfono del supermercado. Aunque esta información puede no ser directamente relevante para el análisis de patrones de compra, sirve como dato de contacto.

Fecha: Fecha y hora en que se realizó la compra. Es fundamental para análisis temporales, como identificar picos de compra durante el día, la semana o tendencias dependiendo de la temporada del año/mes.

Factura: Número o código de la factura asociada a cada compra. Un identificador único para cada transacción que permite el seguimiento de las compras individuales.

IVA (10%, 21%, 5%): Porcentajes de IVA aplicados a los productos adquiridos. Estos datos son cruciales para análisis financieros y para entender cómo los diferentes tipos de productos contribuyen a las ventas totales. Sin IVA: Monto total de los productos exentos de IVA. Ofrece una visión de la proporción de productos no gravados en las compras. IVA: Monto total del IVA cobrado en la compra. Un indicador importante de la carga fiscal de las transacciones.

Una vez que hemos importado los datos a un dataframe, estamos listos para realizar análisis exploratorio de datos, visualizaciones y responder preguntas específicas sobre los patrones y tendencias presentes en los datos de los tickets de supermercado. Esta etapa generalmente implica la aplicación de diversas técnicas de análisis de datos, como agregación, filtrado, agrupación, y visualización de datos.

```{r importacion, cache = F, echo = F, message = F, warning = F, tidy = F}
#Cargamos los nombres de cada tiket (guardados en la carpeta data)
files <- list.files(path = "./data", pattern = ".txt", full.names = TRUE)

#Creamos una lista que contendrá cada ticket.
tickets <- list()

#Asignamos las líneas de los archivos .txt
for (file in files) {
  linea <- read_lines(file, locale = locale(encoding = 'latin1'))
  supermercado <- linea[1]
  direccion <- linea[2]
  ciudad <- linea[3]
  telefono <- linea[4]
  fecha <- linea[5]
  
  factura <- linea[6]
  indiceinicio <- grep("Descripción P. Unit Importe", linea) 
  indicefinal <- grep("TOTAL", linea)
  productos <- linea[(indiceinicio + 2):(indicefinal - 1)]
  #productos_fresco <- linea[grep('/kg', linea)]
  iVA_10_idx <- grep("10%", linea)
  iVA_21_idx <- grep("21%", linea)
  iVA_5_idx <- grep("\\b5%", linea) 
  candidatos_sinIVA_idx <- grep("\\b0,00\\b", linea)
  sinIVA_idx <- candidatos_sinIVA_idx[!grepl("PARKING", linea[candidatos_sinIVA_idx])]
  iVA_10_value <- ifelse(length(iVA_10_idx) > 0, linea[iVA_10_idx[1]], NA)
  iVA_21_value <- ifelse(length(iVA_21_idx) > 0, linea[iVA_21_idx[1]], NA)
  iVA_5_value <- ifelse(length(iVA_5_idx) > 0, linea[iVA_5_idx[1]], NA)
  sinIVA_value <- ifelse(length(sinIVA_idx) > 0, linea[sinIVA_idx[1]], NA)
#Creamos un data frame con los datos asignados
  datos <- list(
    Supermercado = supermercado,
    Dirección = direccion,
    Ciudad = ciudad,
    Telefono = telefono,
    Fecha = fecha,
    Productos = productos[-grep('/kg', productos)],
    Factura = factura,
    Iva_10 = iVA_10_value,
    Iva_21 = iVA_21_value,
    Iva_5 = iVA_5_value,
    SinIVA = sinIVA_value,
    stringsAsFactors = FALSE
  
  )
  #Le asigno cada ticket a cada elemento de la lista
  tickets <- append(tickets, datos)
}

#Creamos un dataframe vacio donde añadiremos la información contenida en cada ticket.
# Combinez les éléments de la liste en un seul dataframe
datoscompletos <- do.call(rbind, tickets)
datos_completos<-as.data.frame(datoscompletos)

```

# Preguntas

Una vez establecemos nuestros datos en forma de data frame, con etiquetas precisas y valores correctamente alineados, nos sumergimos en la exploración de posibles patrones dentro de las instancias y entre las características. En este punto, nos vemos inmersos en un proceso creativo, donde surgen preguntas innovadoras mientras exploramos qué aspectos de los datos capturan nuestra atención con mayor intensidad.Esto nos lleva a plantearnos las siguientes preguntas.


```{r}
library(ggplot2)
```

1.  ¿cuáles son los productos más comprados?

```{r}
productos = list()
    for (ticket in tickets) {
      productos <- append(productos, tickets$Productos)
    }
    library(stringr)

    eliminar_numeros <- function(productos) {
      # Aplicar la función a cada elemento de la lista
      eliminar_numeros <- lapply(productos, function(x) {
        # Eliminar el primer número delante de la información
        x <- str_replace(x, "^[0-9]+", "")
        # Eliminar el float del final si hay
        x <- str_replace(x, "[0-9],[0-9]+$", "")
        return(x)
      })
      # Convertir la lista a un vector de caracteres
      eliminar_numeros <- unlist(eliminar_numeros)
      return(eliminar_numeros)
    }
    productos_filtrado <- eliminar_numeros(productos)
    
  

    # Contar la frecuencia de cada producto en la lista
    frecuencia_productos <- table(productos_filtrado)

    # Convertir la tabla de frecuencias en un data frame
    df_frecuencias <- as.data.frame(frecuencia_productos)
    colnames(df_frecuencias) <- c("Producto", "Frecuencia")

    # Ordenar el data frame por frecuencia de mayor a menor
    df_frecuencias <- df_frecuencias[order(-df_frecuencias$Frecuencia),]

    # Obtener los 20 productos más repetidos
    top_10_productos <- head(df_frecuencias, 10)

    # Crear el gráfico circular con los 10 productos más vendidos
    ggplot(top_10_productos, aes(x = "", y = Frecuencia, fill = Producto)) +
      geom_bar(stat = "identity") +
      coord_polar("y", start = 0) +
      theme_void() +
      labs(title = "Frecuencia de los 10 productos más vendidos") +
      scale_fill_manual(values = rainbow(length(top_10_productos$Producto))) + # Colores
      theme(legend.position = "right") # Posición de la leyenda
```

2.  ¿A qué hora se realizan más compras?

```{r}
# Supprimons la partie " OP: " de la variable Fecha
datos_completos$Fecha <- sub(" OP:.*", "", datos_completos$Fecha)

# Extraemos la hora en la variable Fecha
datos_completos$Hora <- format(as.POSIXct(strptime(datos_completos$Fecha, "%d/%m/%Y %H:%M")), format = "%H:%M")

# Miramos las primeras líneas para confirmar que está correctamente estructurado
head(datos_completos$Hora)

# Escojemos solo la hora del formato de hora y minutos "%H:%M"
datos_completos$Hora_solo <- substr(datos_completos$Hora, 1, 2)
# Contar la frecuencia de cada producto en la lista
    frecuencia_compras <- table(datos_completos$Hora_solo)

# Convertir la tabla de frecuencias en un data frame
df_fre_compras <- as.data.frame(frecuencia_compras)
colnames(df_fre_compras) <- c("Hora", "Frequencia")

# Crear un histograma de compras por hora
ggplot(df_fre_compras, aes(x = Hora, y = Frequencia)) +
  geom_bar(stat = "identity", fill = "skyblue", color = "black") +
  labs(title = "Distribución de número de compras por hora",
       x = "Hora",
       y = "Número de compras")

# Gráfico de dispersión de compras por hora

# Crear un vector de horas con los valores de la columna Hora
horas <- c("18:56", "13:41", "19:20", "11:19", "12:47", "17:13", "19:30", "19:56", "17:15", "20:27", "14:57", "20:12")
# Convertir las horas a un formato adecuado con POSIXct
horas_posix <- as.POSIXct(horas, format = "%H:%M")
# Crear valores para el eje y 
valores <- 1:length(horas)

# Crear el gráfico de dispersión
plot(horas_posix, valores, 
     type = "n",  # Tipo de gráfico: "n" en blanco
     pch = 16,    # Tipo de marcador para los puntos
     col = "blue",   # Color de los puntos y líneas
     xlab = "Hora",  # Etiqueta del eje x
     ylab = "Valor",  # Etiqueta del eje y
     main = "Gráfico de Dispersión con Horas")

# Agregar los puntos sin líneas entre ellos
points(horas_posix, valores, pch = 16, col = "skyblue")
# Pongo los valores de las horas donde se encuentran los puntos y roto las etiquetas del eje x para que sean legibles
axis(1, at = horas_posix, labels = format(horas_posix, "%H:%M"), las = 2)
```

3.  ¿Cual es el valor medio de ingresos por cada tipo de porcentaje del Impuesto al Valor Añadido (IVA)?

```{r}
#Hacemos 4 data frames para poder organizar los datos del IVA, 
#por distintos tipos de porcentajes

IVA_10DF <- datos_completos %>%
  select(Iva_10) %>%
  separate(Iva_10, into = c("IVA", "Base", "ImporteIVA"), sep = " ")%>%
   mutate(Base = as.numeric(gsub(",", ".", Base, fixed = TRUE)),
          ImporteIVA = as.numeric(gsub(",", ".", ImporteIVA, fixed = TRUE)))
  
IVA_5DF<- datos_completos %>%
  select(Iva_5)%>%
  separate(Iva_5, into = c("IVA", "Base", "ImporteIVA"), sep = " ")%>%
   mutate(Base = as.numeric(gsub(",", ".", Base, fixed = TRUE)),
          ImporteIVA = as.numeric(gsub(",", ".", ImporteIVA, fixed = TRUE)))
IVA_21DF<- datos_completos %>%
  select(Iva_21)%>%
  separate(Iva_21, into = c("IVA", "Base", "ImporteIVA"), sep = " ")%>%
   mutate(Base = as.numeric(gsub(",", ".", Base, fixed = TRUE)),
          ImporteIVA = as.numeric(gsub(",", ".", ImporteIVA, fixed = TRUE)))
IVA_00DF<- datos_completos %>%
  select(SinIVA)%>%
  separate(SinIVA, into = c("IVA", "Base", "ImporteIVA"), sep = " ")%>%
   mutate(Base = as.numeric(gsub(",", ".", Base, fixed = TRUE)),
          ImporteIVA = as.numeric(gsub(",", ".", ImporteIVA, fixed = TRUE)))

# Calcular el promedio de la columna Base para cada tasa de IVA
promedio_base_10 <- IVA_10DF %>% summarise(PromedioBase = mean(Base, na.rm = TRUE))
promedio_base_5 <- IVA_5DF %>% summarise(PromedioBase = mean(Base, na.rm = TRUE))
promedio_base_21 <- IVA_21DF %>% summarise(PromedioBase = mean(Base, na.rm = TRUE))
promedio_base_0 <- IVA_00DF %>% summarise(PromedioBase = mean(Base, na.rm = TRUE))

promedios_base <- data.frame(
  IVA = c("10%", "5%", "21%", "0%"),
  PromedioBase = c(promedio_base_10$PromedioBase, promedio_base_5$PromedioBase, 
                   promedio_base_21$PromedioBase, promedio_base_0$PromedioBase)
)
library(ggplot2)

ggplot(promedios_base, aes(x = IVA, y = PromedioBase, fill = IVA)) +
  geom_bar(stat = "identity") +
  labs(title = "Comparación de los Promedios de Base Imponible por Tasa de IVA",
       x = "Tasa de IVA",
       y = "Promedio de Base Imponible") +
  theme_minimal()

```

4.  ¿Cuáles son los productos menos comprados?

```{r}
# Contar la frecuencia de cada producto en la lista
frecuencia_productos <- table(productos_filtrado)

# Convertir la tabla de frecuencias en un data frame
df_frecuencias <- as.data.frame(frecuencia_productos)
colnames(df_frecuencias) <- c("Producto", "Frecuencia")


df_frec_prod <- df_frecuencias%>%
  mutate(Producto = tolower(Producto))%>%
 
  mutate(Producto = gsub("-", " ", Producto))%>%
  mutate(Producto = gsub("[0-9]", "", Producto))%>%
  mutate(Producto = gsub(",", "", Producto))%>%
  mutate(Producto = gsub("\\s+", " ", Producto))%>%
  mutate(Producto = str_trim(Producto))

df_frec_prod <- df_frec_prod%>%
  group_by(Producto)%>%
  summarise(count=n())
# Ordenar el data frame por frecuencia de menor a mayor
df_frecuencias <- df_frecuencias[order(df_frecuencias$Frecuencia),]

# Obtener los 10 productos menos repetidos
top_10_productos <- head(df_frecuencias, 10)

# Crear el gráfico circular con los 10 productos menos vendidos
ggplot(top_10_productos, aes(x = "", y = count, fill = Producto)) +
  geom_bar(stat = "identity") +
  coord_polar("y", start = 0) +
  theme_void() +
  labs(title = "Frecuencia de los 10 productos menos vendidos") +
  scale_fill_manual(values = rainbow(length(top_10_productos$Producto))) + # Colores
  theme(legend.position = "right") # Posición de la leyenda
```